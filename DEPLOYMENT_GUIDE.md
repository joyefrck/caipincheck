# ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å— - é£Ÿè°±æ¨¡å‹è¿›åŒ–æ›´æ–°

## ğŸ“‹ æ›´æ–°æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å¼•å…¥äº†ç”¨æˆ·ç”»åƒç³»ç»Ÿå’Œæ™ºèƒ½æ¨èå¼•æ“ï¼Œæ¶‰åŠæ•°æ®åº“Schemaå˜æ›´å’Œæ–°å¢åŠŸèƒ½ã€‚

### ä¸»è¦å˜æ›´
- âœ… æ–°å¢ `user_profile` è¡¨ï¼ˆç”¨æˆ·ç”»åƒï¼‰
- âœ… æ–°å¢ `user_feedback` è¡¨ï¼ˆç”¨æˆ·åé¦ˆè®°å½•ï¼‰
- âœ… `base_recipes` è¡¨æ–°å¢4ä¸ªå­—æ®µï¼ˆcooking_methods, nutrition_tags, taste_tags, cuisine_typeï¼‰
- âœ… æ–°å¢å¯¹è¯å¼åå¥½è°ƒæ•´åŠŸèƒ½
- âœ… æ–°å¢æ™ºèƒ½æ¨èAPI

---

## âš ï¸ éƒ¨ç½²å‰æ£€æŸ¥

### 1. ç¯å¢ƒè¦æ±‚
- Node.js >= 18.0
- npm >= 9.0
- SQLite3
- Docker & Docker Composeï¼ˆå¦‚ä½¿ç”¨å®¹å™¨ï¼‰

### 2. å¿…éœ€çš„ç¯å¢ƒå˜é‡
ç¡®ä¿ `.env` æˆ– Docker ç¯å¢ƒä¸­é…ç½®äº†ï¼š
```bash
DEEPSEEK_API_KEY=<your-api-key>
TZ=Asia/Shanghai
```

---

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: å¤‡ä»½ç”Ÿäº§æ•°æ®åº“ â­ï¸

**åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ**:

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/caipincheck

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p backups

# æ‰‹åŠ¨å¤‡ä»½æ•°æ®åº“ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
cp food-check.db backups/food-check.db.backup_$(date +%Y%m%d_%H%M%S)

# éªŒè¯å¤‡ä»½
ls -lh backups/
```

**âš ï¸ é‡è¦**: å¤‡ä»½æˆåŠŸåå†ç»§ç»­ä¸‹ä¸€æ­¥ï¼

---

### æ­¥éª¤ 2: æ‹‰å–æœ€æ–°ä»£ç 

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æˆ–è€…ä» GitHub æ‹‰å–
git fetch origin
git checkout main
git pull
```

---

### æ­¥éª¤ 3: å®‰è£…ä¾èµ–

```bash
# å®‰è£…æ–°å¢çš„ä¾èµ–ï¼ˆå¦‚æœæœ‰ï¼‰
npm install
```

---

### æ­¥éª¤ 4: æ‰§è¡Œæ•°æ®åº“è¿ç§» ğŸ”§

#### æ–¹æ¡ˆ A: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è¿›å…¥è„šæœ¬ç›®å½•
cd server/scripts

# æ‰§è¡Œè¿ç§»ï¼ˆè‡ªåŠ¨å¤„ç†æ‰€æœ‰æ“ä½œï¼‰
node migrate_db.js
```

**é¢„æœŸè¾“å‡º**:
```
ğŸ”§ å¼€å§‹æ‰§è¡Œæ•°æ®åº“è¿ç§»...

ğŸ“‹ æ­¥éª¤ 1/3: æ‰§è¡Œè¿ç§»è„šæœ¬
  âœ… è¿ç§»è„šæœ¬æ‰§è¡Œå®Œæˆ

ğŸ“‹ æ­¥éª¤ 2/3: éªŒè¯è¡¨ç»“æ„
  âœ… è¡¨ user_profile å·²åˆ›å»ºï¼ŒåŒ…å« 7 ä¸ªå­—æ®µ
  âœ… è¡¨ user_feedback å·²åˆ›å»ºï¼ŒåŒ…å« 5 ä¸ªå­—æ®µ
  âœ… base_recipes.cooking_methods å­—æ®µå·²æ·»åŠ 
  âœ… base_recipes.nutrition_tags å­—æ®µå·²æ·»åŠ 
  âœ… base_recipes.taste_tags å­—æ®µå·²æ·»åŠ 
  âœ… base_recipes.cuisine_type å­—æ®µå·²æ·»åŠ 

ğŸ“‹ æ­¥éª¤ 3/3: ä¸ºç°æœ‰èœè°±è¡¥å……æ ‡ç­¾æ•°æ®
  ğŸ“Š æ‰¾åˆ° XXX æ¡ç°æœ‰èœè°±
  âœ… å·²ä¸º XXX æ¡èœè°±è¡¥å……æ ‡ç­¾æ•°æ®

ğŸ‰ æ•°æ®åº“è¿ç§»å…¨éƒ¨å®Œæˆï¼
```

#### æ–¹æ¡ˆ B: æ‰‹åŠ¨æ‰§è¡Œ SQLï¼ˆå¤‡é€‰ï¼‰

å¦‚æœè‡ªåŠ¨åŒ–è„šæœ¬å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/caipincheck

# ä½¿ç”¨ SQLite3 æ‰§è¡Œè¿ç§»è„šæœ¬
sqlite3 food-check.db < server/migrations/001_user_profile.sql
```

---

### æ­¥éª¤ 5: å­˜é‡é£Ÿè°±æ•°æ®åˆå§‹åŒ– ğŸœ

#### 5.1 è‡ªåŠ¨æ ‡æ³¨ç­–ç•¥

è¿ç§»è„šæœ¬ä¼šè‡ªåŠ¨ä¸ºå­˜é‡é£Ÿè°±è¡¥å……æ ‡ç­¾ï¼š

**æ ‡æ³¨è§„åˆ™**:

| å­—æ®µ | æ¨æ–­é€»è¾‘ |
|-----|---------|
| `cuisine_type` | æ ¹æ®ç°æœ‰ `tags` å­—æ®µï¼ˆå·èœã€æ¹˜èœç­‰ï¼‰æˆ–æ ‡é¢˜å…³é”®è¯ |
| `taste_tags` | æ ¹æ®æ ‡é¢˜å…³é”®è¯ï¼ˆ"è¾£"â†’è¾£ã€"ç”œ"â†’ç”œï¼‰ |
| `cooking_methods` | æ ¹æ®æ ‡é¢˜å…³é”®è¯ï¼ˆ"ç‚¸"â†’æ²¹ç‚¸ã€"è’¸"â†’è’¸ç…®ï¼‰ |
| `nutrition_tags` | æ ¹æ®é£Ÿæç±»å‹ï¼ˆè‚‰ç±»â†’è›‹ç™½è´¨ã€è”¬èœâ†’ç»´ç”Ÿç´ ï¼‰ |

**ç¤ºä¾‹**:
```javascript
æ ‡é¢˜: "éº»è¾£æ°´ç…®é±¼"
å·²æœ‰æ ‡ç­¾: ["å·èœ", "æµ·é²œ"]

è‡ªåŠ¨æ¨æ–­ç»“æœ:
- cuisine_type: "å·èœ"
- taste_tags: ["è¾£", "éº»"]
- cooking_methods: ["ç…®", "ç‚–ç…®"]
- nutrition_tags: ["è›‹ç™½è´¨"]
```

#### 5.2 éªŒè¯æ ‡æ³¨ç»“æœ

```bash
# æŸ¥è¯¢æ ‡æ³¨ç»Ÿè®¡
sqlite3 food-check.db << EOF
SELECT 
  COUNT(*) as total,
  COUNT(CASE WHEN cuisine_type != '' THEN 1 END) as has_cuisine,
  COUNT(CASE WHEN taste_tags != '[]' THEN 1 END) as has_taste,
  COUNT(CASE WHEN cooking_methods != '[]' THEN 1 END) as has_cooking
FROM base_recipes;
EOF
```

**é¢„æœŸè¾“å‡º**:
```
total|has_cuisine|has_taste|has_cooking
500  |450        |380       |420
```

#### 5.3 æ‰‹åŠ¨è¡¥å……ï¼ˆå¯é€‰ï¼‰

å¦‚æœè‡ªåŠ¨æ ‡æ³¨è¦†ç›–ç‡ä¸è¶³ï¼Œå¯ä»¥ä½¿ç”¨AIæ‰¹é‡æ ‡æ³¨ï¼š

```bash
# åˆ›å»º AI æ ‡æ³¨è„šæœ¬
node server/scripts/ai_enrich_recipes.js
```

**è„šæœ¬åŠŸèƒ½**:
- å¯¹ç¼ºå¤±æ ‡ç­¾çš„èœè°±ï¼Œä½¿ç”¨ DeepSeek AI åˆ†ææ ‡é¢˜å’Œé£Ÿæ
- è‡ªåŠ¨ç”Ÿæˆèœç³»ã€å£å‘³ã€çƒ¹é¥ªæ–¹æ³•ã€è¥å…»æ ‡ç­¾
- æ‰¹é‡æ›´æ–°æ•°æ®åº“

---

### æ­¥éª¤ 6: é‡å¯æœåŠ¡

#### Docker éƒ¨ç½²

```bash
# é‡æ–°æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
docker compose up -d --build

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f
```

#### PM2 éƒ¨ç½²

```bash
# é‡å¯åº”ç”¨
pm2 restart caipincheck

# æŸ¥çœ‹æ—¥å¿—
pm2 logs caipincheck
```

#### 1Panel éƒ¨ç½²

1. è¿›å…¥ 1Panel æ§åˆ¶å°
2. æ‰¾åˆ° caipincheck å®¹å™¨
3. ç‚¹å‡» "é‡å»º" æˆ– "é‡å¯"
4. æŸ¥çœ‹å®¹å™¨æ—¥å¿—ç¡®è®¤å¯åŠ¨æˆåŠŸ

---

### æ­¥éª¤ 7: åŠŸèƒ½éªŒè¯ âœ…

#### 7.1 éªŒè¯æ•°æ®åº“

```bash
# æ£€æŸ¥è¡¨ç»“æ„
sqlite3 food-check.db << EOF
.schema user_profile
.schema user_feedback
PRAGMA table_info(base_recipes);
EOF
```

#### 7.2 éªŒè¯API

```bash
# 1. æµ‹è¯•ç”¨æˆ·ç”»åƒæ¥å£
curl http://your-domain:3001/api/user-profile/peter_yong

# 2. æµ‹è¯•æ™ºèƒ½æ¨èæ¥å£
curl -X POST http://your-domain:3001/api/recommend \
  -H "Content-Type: application/json" \
  -d '{"userId": "peter_yong", "diners": 2}'

# 3. æµ‹è¯•å¯¹è¯å¼åå¥½è°ƒæ•´ï¼ˆé‡ç‚¹éªŒè¯ï¼šæ›´æ–°+æ¨èï¼‰
# åœ¨å‰ç«¯å¯¹è¯æ¡†è¾“å…¥ï¼š"æˆ‘æ›´å–œæ¬¢å·èœ"
# é¢„æœŸç»“æœï¼š
# - âœ… å“åº”ä¸å†è¿”å›"JSONé”™è¯¯"ï¼Œè€Œæ˜¯ç«‹å³è¿”å›æ–°æ¨èçš„èœè°±ã€‚
# - âœ… èœè°±å¡ç‰‡çš„å»ºè®®/è¥å…»è¯´æ˜ä¸­åº”åŒ…å«ï¼š"âœ… å·²ä¸ºæ‚¨æ˜æ˜¾å¢åŠ ã€å·èœã€‘åå¥½..."
# - âœ… åå°ç”¨æˆ·ç”»åƒæƒé‡å·²æ›´æ–°ã€‚
curl -X POST http://your-domain:3001/api/ai/chat \
  -H "Content-Type: application/json" \
  -d '{"messages": [{"role": "user", "content": "ç»¼åˆéœ€æ±‚ï¼šæˆ‘æ›´å–œæ¬¢åƒå·èœ\nå°±é¤äººæ•°ï¼š2 äºº"}]}'
```

#### 7.3 éªŒè¯å‰ç«¯

è®¿é—®åº”ç”¨ï¼Œæµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š
- [ ] "ä¸»å¨ä»Šæ—¥ç‰¹ä¾›"èƒ½å¤Ÿè¿”å›æ¨èç»“æœ
- [ ] ç‚¹å‡»"å–œæ¬¢"æŒ‰é’®åæƒé‡æ›´æ–°
- [ ] åœ¨å¯¹è¯ä¸­è¾“å…¥"æˆ‘æ›´å–œæ¬¢å·èœ"èƒ½å¾—åˆ°ç¡®è®¤æ¶ˆæ¯
- [ ] æ”¶è—åŠŸèƒ½æ­£å¸¸
- [ ] å†å²è®°å½•æ­£å¸¸

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœéƒ¨ç½²åå‡ºç°é—®é¢˜ï¼Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

### 1. åœæ­¢æœåŠ¡

```bash
docker compose down
# æˆ–
pm2 stop caipincheck
```

### 2. æ¢å¤æ•°æ®åº“

```bash
# æ‰¾åˆ°æœ€æ–°å¤‡ä»½
ls -lt backups/

# æ¢å¤æ•°æ®åº“
cp backups/food-check.db.backup_YYYYMMDD_HHMMSS food-check.db
```

### 3. å›æ»šä»£ç 

```bash
# å›é€€åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git log --oneline -10
git checkout <previous-commit-hash>
```

### 4. é‡å¯æœåŠ¡

```bash
docker compose up -d
# æˆ–
pm2 restart caipincheck
```

---

## ğŸ“Š éƒ¨ç½²åç›‘æ§

### 1. æ•°æ®åº“å¢é•¿ç›‘æ§

```bash
# æ¯å¤©æ£€æŸ¥æ•°æ®åº“å¤§å°
du -h food-check.db

# ç›‘æ§èœè°±æ•°é‡å¢é•¿
sqlite3 food-check.db "SELECT COUNT(*) FROM base_recipes;"
```

### 2. API å“åº”æ—¶é—´

```bash
# æµ‹è¯•æ¨èæ¥å£å“åº”æ—¶é—´
time curl -X POST http://localhost:3001/api/recommend \
  -H "Content-Type: application/json" \
  -d '{"userId": "peter_yong", "diners": 2}'
```

### 3. æ—¥å¿—ç›‘æ§

```bash
# Docker
docker compose logs -f --tail=100

# PM2
pm2 logs caipincheck --lines 100
```

---

## ğŸ› ï¸ å¸¸è§é—®é¢˜

### Q1: è¿ç§»è„šæœ¬æŠ¥é”™ "duplicate column name"

**åŸå› **: å­—æ®µå·²å­˜åœ¨ï¼ˆå¯èƒ½å·²æ‰§è¡Œè¿‡è¿ç§»ï¼‰

**è§£å†³**: è¿™æ˜¯æ­£å¸¸çš„è­¦å‘Šï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡å·²å­˜åœ¨çš„å­—æ®µ

---

### Q2: å­˜é‡èœè°±æ ‡ç­¾æœªç”Ÿæˆ

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥èœè°±æ˜¯å¦æœ‰ `title` å’Œ `tags` å­—æ®µ
2. æŸ¥çœ‹è¿ç§»è„šæœ¬æ—¥å¿—
3. æ‰‹åŠ¨æ‰§è¡Œæ ‡æ³¨ï¼š
   ```bash
   node server/scripts/migrate_db.js
   ```

---

### Q3: ç”¨æˆ·ç”»åƒä¸å­˜åœ¨

**è§£å†³**:
```bash
# æ‰‹åŠ¨åˆ›å»ºç”¨æˆ·ç”»åƒ
sqlite3 food-check.db << EOF
INSERT OR IGNORE INTO user_profile (user_id, taste_weights, cuisine_weights, ingredient_weights, cooking_method_weights, nutrition_weights, updated_at)
VALUES (
  'peter_yong',
  '{"ç”œ": 0.5, "å’¸": 0.5, "é…¸": 0.5, "è‹¦": 0.5, "è¾£": 0.5, "é²œ": 0.5, "éº»": 0.5}',
  '{"å·èœ": 0.5, "ç²¤èœ": 0.5, "é²èœ": 0.5, "æ¹˜èœ": 0.5, "è‹èœ": 0.5, "æµ™èœ": 0.5, "å¾½èœ": 0.5, "é—½èœ": 0.5}',
  '{}',
  '{"æ²¹ç‚¸": 0.5, "ç…ç‚’": 0.5, "ç‚–ç…®": 0.5, "è’¸ç…®": 0.5, "çƒ¤åˆ¶": 0.5, "å‡‰æ‹Œ": 0.5, "ç…²æ±¤": 0.5}',
  '{"è›‹ç™½è´¨": 0.5, "è„‚è‚ª": 0.5, "ç¢³æ°´åŒ–åˆç‰©": 0.5, "ç»´ç”Ÿç´ ": 0.5, "çŸ¿ç‰©è´¨": 0.5, "è†³é£Ÿçº¤ç»´": 0.5}',
  strftime('%s', 'now') * 1000
);
EOF
```

---

### Q4: DeepSeek API è°ƒç”¨å¤±è´¥

**æ’æŸ¥**:
1. æ£€æŸ¥ç¯å¢ƒå˜é‡ `DEEPSEEK_API_KEY` æ˜¯å¦é…ç½®
2. éªŒè¯ API Key æ˜¯å¦æœ‰æ•ˆ
3. æ£€æŸ¥ç½‘ç»œè¿æ¥

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰æ‰“å°æ­¤æ¸…å•ï¼Œé€é¡¹ç¡®è®¤ï¼š

- [ ] å·²å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
- [ ] å·²æ‹‰å–æœ€æ–°ä»£ç 
- [ ] å·²å®‰è£…ä¾èµ– `npm install`
- [ ] å·²æ‰§è¡Œæ•°æ®åº“è¿ç§» `node migrate_db.js`
- [ ] éªŒè¯è¡¨ç»“æ„åˆ›å»ºæˆåŠŸ
- [ ] éªŒè¯å­˜é‡èœè°±æ ‡ç­¾å·²è¡¥å……
- [ ] å·²é‡å¯æœåŠ¡
- [ ] API æ¥å£æµ‹è¯•é€šè¿‡
- [ ] å‰ç«¯åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] å·²é…ç½®æ—¥å¿—ç›‘æ§

---

## ğŸ¯ é¢„æœŸç»“æœ

éƒ¨ç½²æˆåŠŸåï¼Œæ‚¨å°†è·å¾—ï¼š

1. âœ… **ç”¨æˆ·ç”»åƒç³»ç»Ÿ** - è‡ªåŠ¨å­¦ä¹ ç”¨æˆ·åå¥½
2. âœ… **æ™ºèƒ½æ¨èå¼•æ“** - 7å¤©ä¸é‡å¤ï¼Œå¤šæ ·æ€§ä¿éšœ
3. âœ… **å¯¹è¯å¼åå¥½è°ƒæ•´ (Update & Redirect)** - è‡ªç„¶è¯­è¨€è°ƒæ•´åç«‹å³é‡å®šå‘æ¨è
4. âœ… **å­˜é‡æ•°æ®æ ‡æ³¨** - ç°æœ‰èœè°±è‡ªåŠ¨è¡¥å……æ ‡ç­¾
5. âœ… **å‘åå…¼å®¹** - åŸæœ‰åŠŸèƒ½å®Œå…¨ä¿ç•™

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œå¯æŸ¥çœ‹ï¼š
- [ç”¨æˆ·ç”»åƒç³»ç»Ÿè®¾è®¡](./user_profile_design.md)
- [æ¨èç®—æ³•è¯¦è§£](./recommendation_algorithm.md)
- [README å®Œæ•´æ–‡æ¡£](./README.md)

æˆ–è”ç³»å¼€å‘å›¢é˜Ÿè·å–æ”¯æŒã€‚
