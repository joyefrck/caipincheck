# æ¨èç®—æ³•è¯´æ˜æ–‡æ¡£

## 1. ç®—æ³•æ¦‚è¿°

è”¡å“æ£€çš„æ™ºèƒ½æ¨èå¼•æ“é‡‡ç”¨**åŸºäºç”¨æˆ·ç”»åƒçš„å¤šç»´åº¦åŠ æƒè¯„åˆ†ç®—æ³•**ï¼Œç»“åˆ**å¤šæ ·æ€§çº¦æŸ**å’Œ**æ—¶é—´å»é‡ç­–ç•¥**ï¼Œä¸ºç”¨æˆ·ç”Ÿæˆä¸ªæ€§åŒ–ä¸”è¥å…»å‡è¡¡çš„èœè°±ç»„åˆã€‚

### 1.1 è®¾è®¡ç›®æ ‡

- âœ… **ä¸ªæ€§åŒ–** - æ ¹æ®ç”¨æˆ·åå¥½ç²¾å‡†æ¨è
- âœ… **å¤šæ ·æ€§** - é¿å…é£Ÿæã€çƒ¹é¥ªæ–¹æ³•ã€èœç³»é‡å¤
- âœ… **è¥å…»å‡è¡¡** - ä¿è¯æ¨èèœå“çš„è¥å…»äº’è¡¥
- âœ… **æ–°é²œæ„Ÿ** - 7å¤©å†…ä¸é‡å¤æ¨è
- âœ… **å®¹é”™æ€§** - å€™é€‰æ± ä¸è¶³æ—¶çš„é™çº§ç­–ç•¥

---

## 2. æ¨èæµç¨‹

```mermaid
flowchart TD
    Start[å¼€å§‹è¯·æ±‚] --> Type{è¯·æ±‚ç±»å‹?}
    
    Type -->|ç›´æ¥æ¨è| GetProfile[è·å–ç”¨æˆ·ç”»åƒ]
    Type -->|å¯¹è¯å¼å»ºè®®| ParsePref[è§£æå¯¹è¯åå¥½]
    
    ParsePref --> HasPref{æ˜¯å¦æœ‰åå¥½?}
    HasPref -->|æ˜¯| UpdateDB[æ›´æ–°ç”»åƒæƒé‡]
    UpdateDB --> Redirect[é‡å®šå‘éœ€æ±‚å…³é”®è¯]
    Redirect --> GetProfile
    HasPref -->|å¦| GetProfile

    GetProfile --> GetHistory[è·å–7å¤©å†å²è®°å½•]
    GetHistory --> FilterCandidates[è¿‡æ»¤å€™é€‰æ± ]
    
    FilterCandidates --> CheckEmpty{å€™é€‰æ± æ˜¯å¦ä¸ºç©º?}
    CheckEmpty -->|æ˜¯| AI_Fallback[AIç”Ÿæˆå…œåº•]
    CheckEmpty -->|å¦| Scoring[å¤šç»´åº¦åŠ æƒè¯„åˆ†]
    
    Scoring --> Sort[æŒ‰è¯„åˆ†é™åºæ’åº]
    Sort --> DiversityFilter[å¤šæ ·æ€§çº¦æŸé€‰æ‹©]
    
    DiversityFilter --> CheckCount{æ»¡è¶³æ•°é‡?}
    CheckCount -->|å¦| Relax[æ”¾å®½å¤šæ ·æ€§é™åˆ¶]
    Relax --> SelectMore[é€‰æ‹©é«˜åˆ†èœå“]
    CheckCount -->|æ˜¯| Format[æ ¼å¼åŒ–å¹¶æ³¨å…¥æç¤º]
    SelectMore --> Format
    
    Format --> Return[è¿”å›æ¨èç»“æœ]
    AI_Fallback --> Return
```

---

## 3. å¤šç»´åº¦è¯„åˆ†ç®—æ³•

### 3.1 è¯„åˆ†å…¬å¼

å¯¹äºæ¯é“å€™é€‰èœè°±ï¼Œè®¡ç®—ç»¼åˆè¯„åˆ†ï¼š

```
æ€»åˆ† = èœç³»åˆ† Ã— 2.0 + å£å‘³åˆ† Ã— 1.5 + çƒ¹é¥ªæ–¹æ³•åˆ† Ã— 1.2 + è¥å…»åˆ† Ã— 1.0 + é£Ÿæåˆ† Ã— 1.0
```

#### 3.1.1 èœç³»è¯„åˆ†
```javascript
if (èœè°±èœç³» in ç”¨æˆ·èœç³»æƒé‡) {
  èœç³»åˆ† = ç”¨æˆ·èœç³»æƒé‡[èœè°±èœç³»] Ã— 2.0  // æœ€é«˜æƒé‡
}
```

**ç¤ºä¾‹**:
- ç”¨æˆ·å·èœæƒé‡ = 0.8
- èœè°±èœç³» = "å·èœ"
- èœç³»åˆ† = 0.8 Ã— 2.0 = **1.6**

#### 3.1.2 å£å‘³è¯„åˆ†
```javascript
å£å‘³åˆ† = Î£ (ç”¨æˆ·å£å‘³æƒé‡[æ ‡ç­¾] Ã— 1.5) for æ ‡ç­¾ in èœè°±å£å‘³æ ‡ç­¾
```

**ç¤ºä¾‹**:
- èœè°±å£å‘³æ ‡ç­¾ = ["è¾£", "å’¸"]
- ç”¨æˆ·æƒé‡: è¾£=0.7, å’¸=0.6
- å£å‘³åˆ† = (0.7 + 0.6) Ã— 1.5 = **1.95**

#### 3.1.3 çƒ¹é¥ªæ–¹æ³•è¯„åˆ†
```javascript
çƒ¹é¥ªæ–¹æ³•åˆ† = Î£ (ç”¨æˆ·çƒ¹é¥ªæ–¹æ³•æƒé‡[æ–¹æ³•] Ã— 1.2) for æ–¹æ³• in èœè°±çƒ¹é¥ªæ–¹æ³•
```

#### 3.1.4 è¥å…»è¯„åˆ†
```javascript
è¥å…»åˆ† = Î£ (ç”¨æˆ·è¥å…»æƒé‡[æ ‡ç­¾] Ã— 1.0) for æ ‡ç­¾ in èœè°±è¥å…»æ ‡ç­¾
```

#### 3.1.5 é£Ÿæè¯„åˆ†
```javascript
é£Ÿæåˆ† = Î£ (ç”¨æˆ·é£Ÿææƒé‡[é£Ÿæ] Ã— 1.0) for é£Ÿæ in èœè°±ä¸»é£Ÿæ(å‰3ä¸ª)
```

### 3.2 è¯„åˆ†æƒé‡è®¾è®¡ç†å¿µ

| ç»´åº¦ | æƒé‡ç³»æ•° | ç†ç”± |
|------|---------|------|
| èœç³» | 2.0 | èœç³»åå¥½é€šå¸¸æœ€ç¨³å®šï¼Œæ˜¯ç”¨æˆ·é€‰æ‹©çš„é¦–è¦å› ç´  |
| å£å‘³ | 1.5 | å£å‘³æ˜¯æ ¸å¿ƒä½“éªŒï¼Œä½†å¯èƒ½è·¨èœç³» |
| çƒ¹é¥ªæ–¹æ³• | 1.2 | å½±å“èœå“å£æ„Ÿå’Œå¥åº·ï¼Œé‡è¦æ€§ä¸­ç­‰ |
| è¥å…» | 1.0 | é•¿æœŸå¥åº·è€ƒé‡ï¼ŒåŸºç¡€æƒé‡ |
| é£Ÿæ | 1.0 | ç”¨æˆ·å¯èƒ½ä¸æ¸…æ¥šå…·ä½“é£Ÿæåå¥½ï¼ŒåŸºç¡€æƒé‡ |

---

## 4. å¤šæ ·æ€§çº¦æŸ

### 4.1 ä¸‰é‡çº¦æŸæœºåˆ¶

ä¸ºé¿å…æ¨èç»“æœå•ä¸€ï¼Œå¼•å…¥ä»¥ä¸‹çº¦æŸï¼š

#### 4.1.1 é£Ÿæå¤šæ ·æ€§
```javascript
ä¸»é£Ÿæé‡å¤æ£€æŸ¥: 
  if (èœè°±ä¸»é£Ÿæ(å‰2ä¸ª) âˆ© å·²é€‰èœå“ä¸»é£Ÿæ â‰  âˆ…) {
    è·³è¿‡è¯¥èœè°±
  }
```

**ç›®çš„**: é¿å…"é¸¡è‚‰å¥—é¤"ï¼ˆ3é“èœéƒ½æ˜¯é¸¡è‚‰ï¼‰

#### 4.1.2 çƒ¹é¥ªæ–¹æ³•å¤šæ ·æ€§
```javascript
çƒ¹é¥ªæ–¹æ³•é‡å¤æ£€æŸ¥:
  if (èœè°±æ‰€æœ‰çƒ¹é¥ªæ–¹æ³• âŠ† å·²é€‰çƒ¹é¥ªæ–¹æ³•é›†åˆ) {
    è·³è¿‡è¯¥èœè°±
  }
```

**ç›®çš„**: é¿å…"æ²¹ç‚¸å¥—é¤"ï¼ˆ3é“èœéƒ½æ˜¯æ²¹ç‚¸ï¼‰

#### 4.1.3 èœç³»å¤šæ ·æ€§
```javascript
èœç³»é‡å¤æ£€æŸ¥:
  if (åŒèœç³»å·²é€‰èœå“æ•°é‡ >= 2) {
    è·³è¿‡è¯¥èœè°±
  }
```

**ç›®çš„**: é¼“åŠ±æ¢ç´¢ä¸åŒèœç³»ï¼ˆä½†å…è®¸æœ€å¤š2é“åŒèœç³»ï¼‰

### 4.2 å¤šæ ·æ€§çº¦æŸä¼ªä»£ç 

```python
selected_recipes = []
used_ingredients = set()
used_cooking_methods = set()
used_cuisines = []

for candidate in sorted_candidates:
    if len(selected_recipes) >= target_count:
        break
    
    # æ£€æŸ¥é£Ÿæå†²çª
    main_ingredients = candidate.ingredients[:2]
    if any(ing in used_ingredients for ing in main_ingredients):
        continue
    
    # æ£€æŸ¥çƒ¹é¥ªæ–¹æ³•å†²çª
    if all(method in used_cooking_methods for method in candidate.cooking_methods):
        continue
    
    # æ£€æŸ¥èœç³»å†²çª
    cuisine_count = used_cuisines.count(candidate.cuisine)
    if cuisine_count >= 2:
        continue
    
    # é€šè¿‡æ‰€æœ‰çº¦æŸï¼Œé€‰æ‹©è¯¥èœè°±
    selected_recipes.append(candidate)
    used_ingredients.update(main_ingredients)
    used_cooking_methods.update(candidate.cooking_methods)
    used_cuisines.append(candidate.cuisine)
```

---

## 5. å¼‚å¸¸å¤„ç†ä¸é™çº§ç­–ç•¥

### 5.1 å€™é€‰æ± ä¸è¶³

**åœºæ™¯**: å¤šæ ·æ€§çº¦æŸè¿‡ä¸¥ï¼Œé€‰å‡ºçš„èœå“æ•°é‡ < ç›®æ ‡æ•°é‡

**ç­–ç•¥**:
```javascript
if (selected_recipes.length < target_count) {
  console.log("âš ï¸ æ”¾å®½å¤šæ ·æ€§é™åˆ¶");
  
  // å¿½ç•¥å¤šæ ·æ€§çº¦æŸï¼Œç›´æ¥æŒ‰è¯„åˆ†é€‰æ‹©
  for (candidate in sorted_candidates) {
    if (selected_recipes.length >= target_count) break;
    if (!å·²é€‰æ‹©(candidate)) {
      selected_recipes.push(candidate);
    }
  }
}
```

### 5.2 å€™é€‰æ± ä¸ºç©º

**åœºæ™¯**: 7å¤©å†å²è¿‡æ»¤åï¼Œæ²¡æœ‰å¯ç”¨èœè°±

**ç­–ç•¥**:
```javascript
if (candidates.length === 0) {
  return {
    error: "å€™é€‰èœè°±æ± ä¸ºç©ºï¼Œè¯·æ·»åŠ æ›´å¤šåŸºç¡€èœè°±"
  };
}
```

**å»ºè®®**: å®šæœŸè¿è¡Œçˆ¬è™«è¡¥å……èœè°±åº“

### 5.3 ç”¨æˆ·ç”»åƒç¼ºå¤±

**åœºæ™¯**: æ–°ç”¨æˆ·æ²¡æœ‰ç”»åƒæ•°æ®

**ç­–ç•¥**:
```javascript
if (!user_profile) {
  // è‡ªåŠ¨åˆ›å»ºé»˜è®¤ç”»åƒï¼ˆæ‰€æœ‰æƒé‡ = 0.5ï¼‰
  await initializeDefaultProfile(userId);
}
```

---

## 6. 7å¤©ä¸é‡å¤é€»è¾‘

### 6.1 å®ç°æœºåˆ¶

```javascript
const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
const recentHistory = await db.query(`
  SELECT id FROM history 
  WHERE created_at > ? 
  ORDER BY created_at DESC
`, [sevenDaysAgo]);

const excludeIds = [...recentHistory.map(r => r.id), ...userProvidedExcludeIds];

const candidates = await db.query(`
  SELECT * FROM base_recipes 
  WHERE id NOT IN (${excludeIds.join(',')})
`);
```

### 6.2 è®¾è®¡è€ƒé‡

- **æ—¶é—´çª—å£**: 7å¤©ï¼ˆå¯é…ç½®ï¼‰
- **æ’é™¤æ¥æº**:
  1. å†å²æ¨èè®°å½•ï¼ˆ`history` è¡¨ï¼‰
  2. ç”¨æˆ·æ‰‹åŠ¨æ’é™¤çš„èœè°±
- **ç›®çš„**: ä¿è¯ç”¨æˆ·æ¯å‘¨éƒ½æœ‰æ–°é²œä½“éªŒ

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 æ•°æ®åº“ç´¢å¼•

```sql
CREATE INDEX idx_base_recipes_cuisine_type ON base_recipes(cuisine_type);
CREATE INDEX idx_user_feedback_created_at ON user_feedback(created_at);
```

### 7.2 è¯„åˆ†è®¡ç®—ä¼˜åŒ–

- ä½¿ç”¨ JavaScript åŸç”Ÿå¯¹è±¡è€Œéæ•°æ®åº“JOIN
- è¯„åˆ†è®¡ç®—åœ¨å†…å­˜ä¸­å®Œæˆï¼Œé¿å…å¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢

### 7.3 ç¼“å­˜ç­–ç•¥ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

```javascript
// ç¼“å­˜ç”¨æˆ·ç”»åƒï¼Œé¿å…æ¯æ¬¡æ¨èéƒ½æŸ¥è¯¢æ•°æ®åº“
const cachedProfile = cache.get(`user_profile:${userId}`);
if (!cachedProfile) {
  cachedProfile = await db.getUserProfile(userId);
  cache.set(`user_profile:${userId}`, cachedProfile, 60); // ç¼“å­˜60ç§’
}
```

---

## 8. æ¨èç»“æœç¤ºä¾‹

### 8.1 è¾“å…¥
```json
{
  "userId": "peter_yong",
  "diners": 3,
  "excludeRecipeIds": []
}
```

### 8.2 è¾“å‡º
```json
{
  "id": "rec-uuid-123",
  "title": "è”¡å¤§å¨ç²¾é€‰å¥—é¤Â·å®«ä¿é¸¡ä¸ç­‰3é“",
  "cuisine": "å·èœ",
  "diners": 3,
  "dishes": [
    {
      "name": "å®«ä¿é¸¡ä¸",
      "ingredients": [...],
      "instructions": [...]
    },
    {
      "name": "æ¸…è’¸é²ˆé±¼",
      "ingredients": [...],
      "instructions": [...]
    },
    {
      "name": "è’œè“‰è¥¿å…°èŠ±",
      "ingredients": [...],
      "instructions": [...]
    }
  ],
  "nutritionInfo": "ğŸ’¡ æ ¹æ®æ‚¨çš„åå¥½æ™ºèƒ½æ¨è 3 é“èœï¼Œå·²ç¡®ä¿é£Ÿæå¤šæ ·ã€çƒ¹é¥ªæ–¹å¼å‡è¡¡ã€è¥å…»äº’è¡¥",
  "tags": ["å·èœ", "æµ·é²œ", "ç´ èœ", "æ¸…æ·¡"],
  "createdAt": 1738502400000
}
```

### 8.3 å¤šæ ·æ€§éªŒè¯

| èœå“ | ä¸»é£Ÿæ | çƒ¹é¥ªæ–¹æ³• | èœç³» |
|-----|-------|---------|------|
| å®«ä¿é¸¡ä¸ | é¸¡è‚‰, èŠ±ç”Ÿ | ç…ç‚’ | å·èœ |
| æ¸…è’¸é²ˆé±¼ | é²ˆé±¼ | è’¸ç…® | ç²¤èœ |
| è’œè“‰è¥¿å…°èŠ± | è¥¿å…°èŠ± | è’¸ç…®, ç‚’ | å®¶å¸¸èœ |

âœ… ä¸»é£Ÿææ— é‡å¤  
âœ… çƒ¹é¥ªæ–¹æ³•å¤šæ ·ï¼ˆç…ç‚’ã€è’¸ç…®ï¼‰  
âœ… èœç³»åˆ†å¸ƒåˆç†ï¼ˆå·èœã€ç²¤èœã€å®¶å¸¸èœï¼‰

---

## 9. ç®—æ³•è°ƒä¼˜å»ºè®®

### 9.1 è°ƒæ•´è¯„åˆ†æƒé‡

å¦‚æœå‘ç°æ¨èç»“æœè¿‡äºé›†ä¸­åœ¨æŸä¸€èœç³»ï¼š
```javascript
// é™ä½èœç³»æƒé‡ç³»æ•°
const cuisineScore = profile.cuisineWeights[recipe.cuisine_type] * 1.5; // ä»2.0é™åˆ°1.5
```

### 9.2 è°ƒæ•´å¤šæ ·æ€§é˜ˆå€¼

å¦‚æœæ€»æ˜¯è§¦å‘"æ”¾å®½é™åˆ¶"ï¼š
```javascript
// æ”¾å®½èœç³»é‡å¤é™åˆ¶
const hasCuisineConflict = cuisineCount >= 3; // ä»2æ”¹ä¸º3
```

### 9.3 è°ƒæ•´æƒé‡å­¦ä¹ é€Ÿç‡

å¦‚æœç”¨æˆ·åå¥½å˜åŒ–å¤ªå¿«ï¼š
```javascript
// é™ä½å•æ¬¡åé¦ˆçš„å½±å“
const delta = feedbackType === 'like' ? 0.05 : -0.02; // ä»0.1/-0.05é™åˆ°0.05/-0.02
```

---

## 10. æµ‹è¯•ç”¨ä¾‹

### 10.1 æ­£å¸¸åœºæ™¯

**è¾“å…¥**: ç”¨æˆ·å–œæ¬¢å·èœï¼ˆæƒé‡0.8ï¼‰ï¼Œ2äººç”¨é¤  
**é¢„æœŸ**: æ¨è2é“å·èœç›¸å…³èœå“ï¼Œé£Ÿæå’Œçƒ¹é¥ªæ–¹æ³•å¤šæ ·

### 10.2 è¾¹ç•Œåœºæ™¯

**è¾“å…¥**: å€™é€‰æ± åªæœ‰5é“èœï¼Œéœ€è¦æ¨è3é“  
**é¢„æœŸ**: æˆåŠŸæ¨è3é“èœï¼ˆå¯èƒ½è§¦å‘æ”¾å®½é™åˆ¶ï¼‰

### 10.3 å¼‚å¸¸åœºæ™¯

**è¾“å…¥**: å€™é€‰æ± ä¸ºç©º  
**é¢„æœŸ**: è¿”å›é”™è¯¯ä¿¡æ¯"å€™é€‰èœè°±æ± ä¸ºç©º"

---

## 12. å¯¹è¯å¼åå¥½åŠ¨æ€è°ƒæ•´ (Update & Redirect)

### 12.1 æ ¸å¿ƒé€»è¾‘

å½“ç”¨æˆ·åœ¨å¯¹è¯æ¡†è¾“å…¥éç‰¹å®šèœåï¼ˆå¦‚â€œæˆ‘å–œæ¬¢åƒè¾£çš„â€ï¼‰æ—¶ï¼Œç³»ç»Ÿä¸å†åªæ˜¯ç®€å•çš„â€œæ›´æ–°é…ç½®â€ï¼Œè€Œæ˜¯æ‰§è¡Œ **â€œæ›´æ–°æƒé‡ + éœ€æ±‚é‡å®šå‘â€** çš„ç»„åˆæ‹³ã€‚

1. **è§£æ (Parse)**: ä½¿ç”¨ AI è¯†åˆ«å¯¹è¯ä¸­çš„å‘³å‹ã€èœç³»è°ƒæ•´æ„å›¾ã€‚
2. **åº”ç”¨ (Apply)**: ç«‹å³æ›´æ–°æ•°æ®åº“ä¸­ `user_profile` çš„ç›¸åº”æƒé‡ã€‚
3. **é‡å®šå‘ (Redirect)**: å°†ç”¨æˆ·çš„åŸå§‹å¯¹è¯ï¼ˆåå¥½æè¿°ï¼‰æå–ä¸ºå…³é”®è¯ï¼ˆå¦‚â€œè¾£â€ï¼‰ï¼Œå¹¶å°†å…¶ä½œä¸ºæœ¬æ¬¡æ¨èçš„æ–°éœ€æ±‚ä¼ å…¥æ¨èå¼•æ“ã€‚
4. **æ³¨å…¥ (Inject)**: åœ¨æœ€ç»ˆè¿”å›çš„èœè°± `nutritionInfo` å­—æ®µä¸­æ³¨å…¥åå¥½æ›´æ–°çš„æˆåŠŸæç¤ºã€‚

### 12.2 ç”¨æˆ·ä½“éªŒæ˜ å°„

| ç”¨æˆ·æ“ä½œ | åç«¯å¤„ç† | å‰ç«¯åé¦ˆ |
|---------|---------|---------|
| è¾“å…¥â€œæˆ‘å–œæ¬¢åƒå·èœâ€ | æ›´æ–°å·èœæƒé‡ -> é‡å®šå‘æœâ€œå·èœâ€ | çœ‹åˆ°â€œâœ… å·²å¢åŠ å·èœåå¥½â€ + ä¸€å¥—å·èœæ¨è |
| è¾“å…¥â€œä¸è¦å¤ªæ²¹è…»â€ | é™ä½â€œæ²¹ç‚¸â€æƒé‡ -> é‡å®šå‘æœâ€œæ¸…æ·¡â€ | çœ‹åˆ°â€œâœ… å·²é™ä½æ²¹ç‚¸åå¥½â€ + æ¸…æ·¡å¥åº·çš„æ¨è |

---

## 13. AI è¾…åŠ©æ•°æ®æ ‡æ³¨ (Data Enrichment)

ä¸ºæå‡æœ¬åœ°ç®—æ³•çš„å‡†ç¡®æ€§ï¼Œç³»ç»Ÿæ”¯æŒé€šè¿‡ AI å¯¹å­˜é‡èœè°±è¿›è¡Œâ€œç”»åƒæ ‡æ³¨â€ï¼š
- **è‡ªåŠ¨æ¨æ–­**: æ ¹æ®èœåå’Œç°æœ‰æ ‡ç­¾æ¨æ–­å…¶æ‰€å±èœç³»ã€ä¸»å‘³å‹ï¼ˆé…¸ç”œè‹¦è¾£å’¸éº»é²œï¼‰ã€‚
- **å­—æ®µè¡¥å…¨**: è¡¥å…¨ `cuisine_type`, `taste_tags`, `cooking_methods`, `nutrition_tags` å­—æ®µã€‚
- **è¿è¡Œæ–¹å¼**: è¿è¡Œ `node server/scripts/migrate_db.js` æˆ–ä¸“ç”¨è„šæœ¬ã€‚
